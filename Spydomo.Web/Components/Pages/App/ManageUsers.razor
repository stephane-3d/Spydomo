@page "/app/manage-users"
@using System.Net
@using System.Net.Http.Json
@using Spydomo.Web.Components.Layout
@using Spydomo.Web.Classes
@using Spydomo.Infrastructure.Clerk
@layout AdminLayout
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Headers
@using Spydomo.DTO
@inject ClerkJsInterop ClerkJs
@inject NavigationManager Navigation
@inject HttpClient Http
@inject ClerkBackend ClerkBackend
@inject IJSRuntime JS
@inject IDialogService DialogService
@rendermode InteractiveServer
@inject ISnackbar Snackbar
@using Spydomo.Web.Components.Pages.App.Dialogs

@using Spydomo.Web.Components.Pages.Parts
@attribute [Authorize]

<PageTitle>Manage users</PageTitle>
<RequireRole Roles="admin">
    <AdminPageHeader
      Title="Manage Users"
      Kicker="Team"
      Icon="ph ph-users"
      Subtext="Invite teammates, set roles, and manage access." />


    @if (!isReady)
    {
        <p>Loading users...</p>
    }
    else
    {
        <div class="mb-3">
            <MudTable Items="users" Hover="true">
                <HeaderContent>
                    <MudTh>Email</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Role</MudTh>
                    <MudTh>Date Created</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Email</MudTd>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>
                        <MudSelect T="string"
                                   Dense="true"
                                   Value="context.Role"
                                   ValueChanged="val => OnRoleChangedAsync(context, val)"
                                   Disabled="@IsSoleAdmin(context)">
                            @foreach (var r in RoleOptions)
                            {
                                <MudSelectItem T="string" Value="@r">@r</MudSelectItem>
                            }
                        </MudSelect>
                    </MudTd>
                    <MudTd>@context.DateCreated.ToString("yyyy-MM-dd")</MudTd>
                    <MudTd>@(context.InvitationStatus == "sent" ? "Invitation sent" : context.InvitationStatus == "accepted" ? "Invitation accepted" : "Active")</MudTd>
                    <MudTd>
                        @if (!IsSoleAdmin(context) && users.Count > 1)
                        {
                            <MudButton Color="Color.Error"
                                       Variant="Variant.Text"
                                       OnClick="() => DeleteUserAsync(context.Id)">
                                Delete
                            </MudButton>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </div>
        <div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenInviteDialogAsync">
                Invite User
            </MudButton>
        </div>


    }
</RequireRole>

@code {
    private List<UserDto> users = new();
    private bool isReady = false;
    private static readonly string[] RoleOptions = new[] { "admin", "user" };

    private bool IsSoleAdmin(UserDto u)
    => string.Equals(u.Role, "admin", StringComparison.OrdinalIgnoreCase)
       && users.Count(x => string.Equals(x.Role, "admin", StringComparison.OrdinalIgnoreCase)) == 1;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error fetching users: " + ex.Message);
        }

    }

    private async Task LoadUsersAsync()
    {
        var token = await ClerkJs.GetSessionTokenAsync();

        var request = new HttpRequestMessage(HttpMethod.Get, "/api/users");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

        try
        {
            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                users = await response.Content.ReadFromJsonAsync<List<UserDto>>() ?? new();
            }
            isReady = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Final fallback error: " + ex.Message);
            Snackbar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }
    }


    private async Task DeleteUserAsync(int userId)
    {
        if (!await Confirm("Are you sure you want to delete this user?"))
            return;

        var token = await ClerkJs.GetSessionTokenAsync();

        var request = new HttpRequestMessage(HttpMethod.Delete, $"/api/users/{userId}");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await Http.SendAsync(request);
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("User deleted!", Severity.Success, config =>
                    {
                        config.VisibleStateDuration = 4000;
                    });
            isReady = false;
            await LoadUsersAsync();
        }
        else
        {
            var errorMessage = await response.Content.ReadAsStringAsync();
            if (string.IsNullOrEmpty(errorMessage) && response.StatusCode == System.Net.HttpStatusCode.Forbidden)
                errorMessage = "Not authorized";

            var err = "Failed to delete user" + (string.IsNullOrEmpty(errorMessage) ? "" : $" (Error: {errorMessage})");
            Snackbar.Add(err, Severity.Error, config =>
                {
                    config.VisibleStateDuration = 4000;
                });
        }
    }

    private async Task<bool> Confirm(string message)
    {
        return await JS.InvokeAsync<bool>("confirm", message);
    }

    private async Task OpenInviteDialogAsync()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Medium, // or MaxWidth.Large / MaxWidth.ExtraLarge
                FullWidth = true
            };

        var dialog = await DialogService.ShowAsync<InviteUserDialog>("Invite New User", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool success && success)
        {
            isReady = false;
            //Snackbar.Add("Invitation sent successfully!", Severity.Success);
            await LoadUsersAsync(); 
        }
    }

    private async Task OnRoleChangedAsync(UserDto user, string newRole)
    {
        // Client-side guard: don’t allow removing the last admin
        if (IsSoleAdmin(user) && !string.Equals(newRole, "admin", StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add("You must keep at least one admin in the account.", Severity.Warning);
            StateHasChanged(); // keep UI consistent
            return;
        }

        var oldRole = user.Role;
        user.Role = newRole; // optimistic UI update

        try
        {
            var token = await ClerkJs.GetSessionTokenAsync();

            var request = new HttpRequestMessage(HttpMethod.Put, $"/api/users/{user.Id}/role")
            {
                Content = JsonContent.Create(new { role = newRole })
            };
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Role updated.", Severity.Success, cfg => cfg.VisibleStateDuration = 3000);
                // Optional: refresh to keep counts consistent if others changed concurrently
                await LoadUsersAsync();
            }
            else
            {
                // Revert on failure
                user.Role = oldRole;

                var body = await response.Content.ReadAsStringAsync();
                var msg = string.IsNullOrWhiteSpace(body) ? response.ReasonPhrase : body;

                if (response.StatusCode is HttpStatusCode.Forbidden or HttpStatusCode.BadRequest or HttpStatusCode.Conflict)
                    Snackbar.Add(msg ?? "Role update denied.", Severity.Error);
                else
                    Snackbar.Add("Failed to update role.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            user.Role = oldRole; // revert
            Snackbar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }

        StateHasChanged();
    }
    
}
