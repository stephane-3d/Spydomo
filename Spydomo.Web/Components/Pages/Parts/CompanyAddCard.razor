@using Spydomo.DTO
@using Spydomo.Infrastructure.Interfaces
@rendermode InteractiveServer

<MudCard Class="mb-4 p-4">
    <MudCardContent>

        <MudText Typo="Typo.h6" Class="mb-2">Track a company</MudText>
        <MudText Typo="Typo.body2" Class="mb-4">Enter the homepage URL of a company you want to follow</MudText>

        <MudStack Direction="Row" Spacing="2">
            <MudTextField @bind-Value="UrlInput"
                          Placeholder="https://www.example.com"
                          Adornment="Adornment.Start"
                          StartText="🌐"
                          Class="flex-grow-1"
                          Immediate="true"
                          Disabled="@IsDisabled"
                          OnKeyDown="@HandleKeyDown"
                          @ref="_urlField"          />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="(IsDisabled || IsProcessing)"
                       OnClick="TryAddCompanyAsync"
                       Style="max-width: 250px;">
                @if (IsProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                    <span>Processing...</span>
                }
                else
                {
                    <span>Track Company</span>
                }
            </MudButton>
        </MudStack>

        @if (Suggestions.Any())
        {
            <div class="mt-3">
                <MudText Typo="Typo.caption" Class="text-secondary mb-2">
                    Suggested additions
                </MudText>

                <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1">
                    @foreach (var s in Suggestions)
                    {
                        <MudChip T="string"
                                 Variant="Variant.Outlined"
                                 Size="Size.Small"
                                 Disabled="@DisableSuggestionClicks"
                                 OnClick="@(() => UseSuggestion(s.Url))">
                            @s.Name
                        </MudChip>
                    }
                </MudStack>
            </div>
        }

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <MudText Color="@StatusColor" Class="mt-2">@StatusMessage</MudText>
        }

    </MudCardContent>
</MudCard>


@code {
    [Parameter] public EventCallback<TrackedCompanyDto> OnCompanyAdded { get; set; }
    
    [Inject] public ICompanyService CompanyService { get; set; } = default!;
    [Inject] public IClientContextService ClientContext { get; set; } = default!;
    [Inject] public ISnackbar Snackbar { get; set; } = default!;
    [Inject] public ICompanySuggestionService SuggestionService { get; set; } = default!;

    public sealed record QuickSuggestion(string Name, string Url);

    [Parameter] public List<QuickSuggestion>? Suggestions { get; set; }
    private bool DisableSuggestionClicks => IsDisabled || IsProcessing;
    
    private string UrlInput { get; set; } = string.Empty;
    private string? StatusMessage { get; set; }
    private Color StatusColor { get; set; } = Color.Default;

    private bool IsProcessing { get; set; } = false;
    private bool IsDisabled => PlanLimitReached || !HasActivePlan;

    private bool PlanLimitReached { get; set; }
    private bool HasActivePlan { get; set; }

    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_initialized && firstRender)
        {
            _initialized = true;

            try
            {
                var clientId = await ClientContext.GetCurrentClientIdAsync();
                var planInfo = await ClientContext.GetCompanyQuotaStatusAsync();

                HasActivePlan = planInfo.HasPlan;
                PlanLimitReached = planInfo.Remaining <= 0;

                if (!HasActivePlan)
                {
                    StatusMessage = "Upgrade to start tracking companies.";
                    StatusColor = Color.Warning;
                }
                else if (PlanLimitReached)
                {
                    StatusMessage = "Upgrade to track more companies.";
                    StatusColor = Color.Warning;
                }

                StateHasChanged(); // Ensure UI updates
            }
            catch (Exception ex)
            {
                Console.WriteLine("Client context init error: " + ex.Message);
            }
        }
    }


    private async Task TryAddCompanyAsync()
    {
        if (string.IsNullOrWhiteSpace(UrlInput))
            return;
        if (IsProcessing) return;

        IsProcessing = true;
        StatusMessage = null;

        try
        {
            var clientId = await ClientContext.GetCurrentClientIdAsync();
            var tracked = await CompanyService.AddOrGetTrackedCompanyAsync(clientId, UrlInput);

            // nice confirmation
            Snackbar.Add($"Tracking started: {tracked.DisplayName}", Severity.Success);

            // clear input
            UrlInput = string.Empty;

            // fetch suggestions for the newly added company's ecosystem
            var sug = await SuggestionService.GetSuggestionsForNewCompanyAsync(clientId, tracked.CompanyId, take: 8);

            Suggestions = sug
                .Where(x => !string.IsNullOrWhiteSpace(x.Url))
                .Select(x => new QuickSuggestion(x.Name, x.Url!))
                .ToList();

            await OnCompanyAdded.InvokeAsync(tracked);
        }
        catch (Exception ex)
        {
            StatusMessage = ex.Message;
            StatusColor = Color.Error;
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" && !IsDisabled && !IsProcessing)
        {
            await TryAddCompanyAsync();
        }
    }

    private void UseSuggestion(string url)
    {
        UrlInput = url;
        StatusMessage = null;
        StatusColor = Color.Default;
        StateHasChanged();

        // optional: focus input (needs @ref, see below)
        _ = FocusUrlInputAsync();
    }

    private MudTextField<string>? _urlField;

    private async Task FocusUrlInputAsync()
    {
        try { if (_urlField is not null) await _urlField.FocusAsync(); } catch { }
    }

}

